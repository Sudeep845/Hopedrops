<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Users - HopeDrops Admin</title>
    <meta
      name="description"
      content="HopeDrops Admin - User Management and System Administration"
    />

    <!-- Favicon -->
    <link
      rel="icon"
      type="image/x-icon"
      href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTE2IDMuMkMxMC4zIDMuMiA1LjcgNy44IDUuNyAxMy41QzUuNyAxOS4yIDEwLjMgMjMuOCAxNiAyMy44QzIxLjcgMjMuOCAyNi4zIDE5LjIgMjYuMyAxMy41QzI2LjMgNy44IDIxLjcgMy4yIDE2IDMuMloiIGZpbGw9IiNkYzM1NDUiLz4KPHBhdGggZD0iTTE2IDhWMTlIMTJWMTZIOVYxMkgxMlY4SDE2WiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+"
    />

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
    />

    <!-- CSS -->
    <link rel="stylesheet" href="../css/style.css" />

    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <!-- SweetAlert2 for alerts -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
    />

    <style>
      .admin-header {
        background: linear-gradient(
          135deg,
          var(--secondary-gray-dark),
          var(--primary-red-dark)
        );
        color: var(--accent-white);
        padding: 1rem 0;
        box-shadow: var(--shadow-md);
      }

      .admin-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .admin-user-info {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .admin-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--primary-red);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
      }

      .users-filters {
        background: var(--accent-white);
        padding: 1.5rem;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-md);
        margin-bottom: 2rem;
      }

      .filter-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        align-items: end;
      }

      .users-table-container {
        background: var(--accent-white);
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-md);
        overflow: hidden;
      }

      .users-table {
        width: 100%;
        border-collapse: collapse;
      }

      .users-table th {
        background: var(--secondary-gray-light);
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid var(--accent-border);
      }

      .users-table td {
        padding: 1rem;
        border-bottom: 1px solid var(--accent-border);
      }

      .users-table tr:hover {
        background: rgba(220, 53, 69, 0.05);
      }

      .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: var(--border-radius-lg);
        font-size: 0.8rem;
        font-weight: 500;
        text-transform: uppercase;
      }

      .status-active {
        background: var(--success-green);
        color: var(--accent-white);
      }

      .status-inactive {
        background: var(--secondary-gray);
        color: var(--accent-white);
      }

      .role-badge {
        padding: 0.25rem 0.5rem;
        border-radius: var(--border-radius);
        font-size: 0.8rem;
        font-weight: 500;
      }

      .role-admin {
        background: var(--primary-red-light);
        color: var(--primary-red-dark);
      }

      .role-hospital {
        background: var(--primary-blue-light);
        color: var(--primary-blue-dark);
      }

      .role-donor {
        background: var(--info-blue-light);
        color: var(--info-blue-dark);
      }

      .pagination-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        padding: 2rem;
      }

      .pagination {
        display: flex;
        gap: 0.5rem;
      }

      .page-btn {
        padding: 0.5rem 1rem;
        border: 1px solid var(--accent-border);
        background: var(--accent-white);
        color: var(--secondary-gray-dark);
        text-decoration: none;
        border-radius: var(--border-radius-sm);
        transition: all var(--transition-fast);
      }

      .page-btn:hover {
        background: var(--primary-red);
        color: var(--accent-white);
        text-decoration: none;
      }

      .page-btn.active {
        background: var(--primary-red);
        color: var(--accent-white);
      }

      .page-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .users-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        background: var(--accent-white);
        padding: 1.5rem;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-sm);
        text-align: center;
      }

      .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: var(--primary-red);
        margin-bottom: 0.5rem;
      }

      .stat-label {
        color: var(--secondary-gray-dark);
        font-size: 0.9rem;
      }

      .action-buttons {
        display: flex;
        gap: 0.5rem;
      }

      .sidebar-nav-link i {
        width: 20px;
        margin-right: 0.5rem;
      }

      .main-content {
        padding: 2rem;
      }

      .page-header {
        margin-bottom: 2rem;
      }

      .page-title {
        color: var(--secondary-gray-dark);
        margin-bottom: 0.5rem;
      }

      .page-description {
        color: var(--secondary-gray);
      }

      .dashboard {
        display: flex;
        min-height: calc(100vh - 80px);
      }

      .navbar-brand {
        display: flex;
        align-items: center;
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--accent-white);
      }

      .logo-icon {
        width: 40px;
        height: 40px;
        background: var(--accent-white);
        color: var(--primary-red);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        font-size: 1.2rem;
      }

      @media (max-width: 768px) {
        .users-table-container {
          overflow-x: auto;
        }

        .action-buttons {
          flex-direction: column;
        }

        .filter-row {
          grid-template-columns: 1fr;
        }

        .dashboard {
          flex-direction: column;
        }

        .sidebar {
          width: 100%;
        }
      }
    </style>
  </head>

  <body>
    <!-- Admin Header -->
    <header class="admin-header">
      <div class="container">
        <nav class="admin-nav">
          <div class="navbar-brand">
            <div class="logo-icon">
              <i class="fas fa-tint"></i>
            </div>
            HopeDrops Admin
          </div>

          <div class="admin-user-info">
            <div class="admin-avatar" id="adminAvatar">A</div>
            <div>
              <div style="font-weight: 500" id="adminName">Administrator</div>
              <div style="font-size: 0.8rem; opacity: 0.8">
                System Administrator
              </div>
            </div>
            <div class="dropdown">
              <button
                class="btn btn-secondary btn-sm dropdown-toggle"
                type="button"
              >
                <i class="fas fa-cog"></i>
              </button>
              <div class="dropdown-menu">
                <a class="dropdown-item" href="../index.html"
                  ><i class="fas fa-home"></i> Home</a
                >
                <a class="dropdown-item" href="#" onclick="logout()"
                  ><i class="fas fa-sign-out-alt"></i> Logout</a
                >
              </div>
            </div>
          </div>
        </nav>
      </div>
    </header>

    <div class="dashboard">
      <!-- Sidebar Navigation -->
      <aside class="sidebar">
        <nav class="sidebar-nav">
          <ul>
            <li class="sidebar-nav-item">
              <a href="dashboard.html" class="sidebar-nav-link">
                <i class="fas fa-tachometer-alt"></i> Dashboard
              </a>
            </li>
            <li class="sidebar-nav-item">
              <a href="manage_hospitals.html" class="sidebar-nav-link">
                <i class="fas fa-hospital"></i> Manage Hospitals
              </a>
            </li>
            <li class="sidebar-nav-item">
              <a href="view_campaigns.html" class="sidebar-nav-link">
                <i class="fas fa-bullhorn"></i> Campaigns
              </a>
            </li>
            <li class="sidebar-nav-item">
              <a href="manage_users.html" class="sidebar-nav-link active">
                <i class="fas fa-users"></i> Users Management
              </a>
            </li>
            <li class="sidebar-nav-item">
              <a href="#" onclick="showReportsModal()" class="sidebar-nav-link">
                <i class="fas fa-chart-bar"></i> Reports
              </a>
            </li>
            <li class="sidebar-nav-item">
              <a
                href="#"
                onclick="showSystemSettings()"
                class="sidebar-nav-link"
              >
                <i class="fas fa-cogs"></i> Settings
              </a>
            </li>
          </ul>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Page Header -->
        <div class="page-header">
          <h2 class="page-title">
            <i class="fas fa-users"></i> Users Management
          </h2>
          <p class="page-description">
            Manage system users, view user activities, and control user access
            permissions.
          </p>
        </div>

        <!-- Users Statistics -->
        <div class="users-stats">
          <div class="stat-card">
            <div class="stat-number" id="totalUsersCount">0</div>
            <div class="stat-label">Total Users</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="activeUsersCount">0</div>
            <div class="stat-label">Active Users</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="donorsCount">0</div>
            <div class="stat-label">Donors</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="hospitalsCount">0</div>
            <div class="stat-label">Hospitals</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="adminsCount">0</div>
            <div class="stat-label">Admins</div>
          </div>
        </div>

        <!-- Filters -->
        <div class="users-filters">
          <div class="filter-row">
            <div class="form-group">
              <label for="roleFilter">Filter by Role</label>
              <select id="roleFilter" class="form-control">
                <option value="">All Roles</option>
                <option value="donor">Donors</option>
                <option value="hospital">Hospitals</option>
                <option value="admin">Admins</option>
              </select>
            </div>
            <div class="form-group">
              <label for="statusFilter">Filter by Status</label>
              <select id="statusFilter" class="form-control">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
              </select>
            </div>
            <div class="form-group">
              <label for="searchInput">Search Users</label>
              <input
                type="text"
                id="searchInput"
                class="form-control"
                placeholder="Search by username, email, or name..."
              />
            </div>
            <div class="form-group">
              <label>&nbsp;</label>
              <button class="btn btn-primary btn-block" onclick="searchUsers()">
                <i class="fas fa-search"></i> Search
              </button>
            </div>
            <div class="form-group">
              <label>&nbsp;</label>
              <button
                class="btn btn-secondary btn-block"
                onclick="clearFilters()"
              >
                <i class="fas fa-times"></i> Clear
              </button>
            </div>
          </div>
        </div>

        <!-- Users Table -->
        <div class="users-table-container">
          <table class="users-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Email</th>
                <th>Full Name</th>
                <th>Role</th>
                <th>Status</th>
                <th>Created</th>
                <th>Last Login</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <tr>
                <td colspan="9" class="text-center">
                  <div class="spinner-border" role="status">
                    <span class="sr-only">Loading...</span>
                  </div>
                  Loading users...
                </td>
              </tr>
            </tbody>
          </table>

          <!-- Pagination -->
          <div class="pagination-container">
            <span id="usersCount">Total: 0 users</span>
            <div id="usersPagination">
              <!-- Pagination buttons will be generated here -->
            </div>
            <span id="pageInfo">Page 1 of 1</span>
          </div>
        </div>
      </main>
    </div>

    <!-- User Details Modal -->
    <div class="modal fade" id="userDetailsModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-user"></i> User Details
            </h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body" id="userDetailsContent">
            <!-- User details will be loaded here -->
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- User Edit Modal -->
    <div class="modal fade" id="userEditModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="fas fa-edit"></i> Edit User</h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="userEditForm">
              <input type="hidden" id="editUserId" />
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="editUsername">Username</label>
                    <input
                      type="text"
                      id="editUsername"
                      class="form-control"
                      readonly
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="editEmail">Email</label>
                    <input
                      type="email"
                      id="editEmail"
                      class="form-control"
                      required
                    />
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="editFullName">Full Name</label>
                    <input type="text" id="editFullName" class="form-control" />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="editRole">Role</label>
                    <select id="editRole" class="form-control" required>
                      <option value="donor">Donor</option>
                      <option value="hospital">Hospital</option>
                      <option value="admin">Admin</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <div class="form-check">
                      <input
                        type="checkbox"
                        id="editIsActive"
                        class="form-check-input"
                      />
                      <label for="editIsActive" class="form-check-label">
                        Active
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="saveUserChanges()"
            >
              <i class="fas fa-save"></i> Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Main Application JS -->
    <script src="../js/main.js"></script>

    <script>
      // Fallback for Utils.escapeHtml if not loaded from main.js
      if (
        typeof Utils === "undefined" ||
        typeof Utils.escapeHtml !== "function"
      ) {
        window.Utils = {
          escapeHtml: function (text) {
            const map = {
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#039;",
            };
            return text ? text.replace(/[&<>"']/g, (m) => map[m]) : "";
          },
        };
      }

      let currentUsersPage = 1;
      let usersFilters = {};

      // Initialize the page
      document.addEventListener("DOMContentLoaded", function () {
        // Check admin authentication
        checkAdminAuth();

        // Load initial data
        loadUsers();
        loadUserStats();

        // Setup search on Enter key
        document
          .getElementById("searchInput")
          .addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              searchUsers();
            }
          });
      });

      function checkAdminAuth() {
        // Check if user is authenticated as admin
        if (typeof Session !== "undefined" && Session.isLoggedIn()) {
          const user = Session.getCurrentUser();
          if (!user || user.role !== "admin") {
            window.location.href = "../login.html";
            return;
          }
        } else {
          window.location.href = "../login.html";
          return;
        }
      }

      function loadUsers(page = 1) {
        currentUsersPage = page;

        // Show loading state
        document.getElementById("usersTableBody").innerHTML = `
          <tr>
            <td colspan="10" class="text-center">
              <div class="spinner-border" role="status">
                <span class="sr-only">Loading...</span>  
              </div>
              Loading users...
            </td>
          </tr>
        `;

        // Get filter values
        const filters = {
          role: document.getElementById("roleFilter")?.value || "",
          status: document.getElementById("statusFilter")?.value || "",
          search: document.getElementById("searchInput")?.value || "",
          page: page,
          limit: 15,
        };

        API.post("get_users.php", filters)
          .then((response) => {
            if (response.success) {
              displayUsers(response.data.users);
              updateUsersCount(response.data.total);
              updateUsersPagination(response.data.pagination);
              updatePageInfo(response.data.pagination);
            } else {
              document.getElementById("usersTableBody").innerHTML = `
                <tr><td colspan="10" class="text-center text-danger">Error: ${response.message}</td></tr>
              `;
            }
          })
          .catch((error) => {
            console.error("Error loading users:", error);
            document.getElementById("usersTableBody").innerHTML = `
              <tr><td colspan="10" class="text-center text-danger">Failed to load users</td></tr>
            `;
          });
      }

      function loadUserStats() {
        API.post("get_users.php", { get_stats: true })
          .then((response) => {
            if (response.success && response.data.stats) {
              const stats = response.data.stats;
              document.getElementById("totalUsersCount").textContent =
                stats.total || 0;
              document.getElementById("activeUsersCount").textContent =
                stats.active || 0;
              document.getElementById("donorsCount").textContent =
                stats.donors || 0;
              document.getElementById("hospitalsCount").textContent =
                stats.hospitals || 0;
              document.getElementById("adminsCount").textContent =
                stats.admins || 0;
            }
          })
          .catch((error) => {
            console.error("Error loading user stats:", error);
          });
      }

      function displayUsers(users) {
        const tbody = document.getElementById("usersTableBody");

        if (!users || users.length === 0) {
          tbody.innerHTML = `
            <tr><td colspan="10" class="text-center text-muted">No users found</td></tr>
          `;
          return;
        }

        tbody.innerHTML = users
          .map((user) => {
            const statusBadge = getStatusBadge(user);
            const roleBadge = getRoleBadge(user.role);
            const lastLogin = user.last_login
              ? new Date(user.last_login).toLocaleDateString()
              : "Never";

            return `
            <tr>
              <td>${user.id}</td>
              <td><strong>${Utils.escapeHtml(user.username)}</strong></td>
              <td>${Utils.escapeHtml(user.email)}</td>
              <td>${Utils.escapeHtml(user.full_name || "N/A")}</td>
              <td>${roleBadge}</td>
              <td>${statusBadge}</td>
              <td>${new Date(user.created_at).toLocaleDateString()}</td>
              <td>${lastLogin}</td>
              <td>
                <div class="action-buttons">
                  <button class="btn btn-info btn-sm" onclick="viewUserDetails(${
                    user.id
                  })" title="View Details">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button class="btn btn-warning btn-sm" onclick="editUser(${
                    user.id
                  })" title="Edit User">
                    <i class="fas fa-edit"></i>
                  </button>
                  ${
                    user.is_active
                      ? `<button class="btn btn-secondary btn-sm" onclick="deactivateUser(${user.id})" title="Deactivate">
                      <i class="fas fa-ban"></i>
                    </button>`
                      : `<button class="btn btn-success btn-sm" onclick="activateUser(${user.id})" title="Activate">
                      <i class="fas fa-check"></i>
                    </button>`
                  }
                </div>
              </td>
            </tr>
          `;
          })
          .join("");
      }

      function getStatusBadge(user) {
        if (!user.is_active) {
          return '<span class="badge badge-secondary">Inactive</span>';
        }
        return '<span class="badge badge-success">Active</span>';
      }

      function getRoleBadge(role) {
        const badges = {
          admin: '<span class="badge badge-danger">Admin</span>',
          hospital: '<span class="badge badge-primary">Hospital</span>',
          donor: '<span class="badge badge-info">Donor</span>',
        };
        return badges[role] || `<span class="badge badge-light">${role}</span>`;
      }

      function searchUsers() {
        loadUsers(1);
      }

      function clearFilters() {
        document.getElementById("roleFilter").value = "";
        document.getElementById("statusFilter").value = "";
        document.getElementById("searchInput").value = "";
        loadUsers(1);
      }

      function updateUsersCount(total) {
        document.getElementById(
          "usersCount"
        ).textContent = `Total: ${total} users`;
      }

      function updatePageInfo(pagination) {
        if (pagination) {
          document.getElementById(
            "pageInfo"
          ).textContent = `Page ${pagination.currentPage} of ${pagination.totalPages}`;
        }
      }

      function updateUsersPagination(pagination) {
        const container = document.getElementById("usersPagination");
        if (!pagination || pagination.totalPages <= 1) {
          container.innerHTML = "";
          return;
        }

        let paginationHTML = '<div class="pagination">';

        // Previous page
        if (pagination.currentPage > 1) {
          paginationHTML += `<a href="#" class="page-btn" onclick="loadUsers(${
            pagination.currentPage - 1
          })">Previous</a>`;
        }

        // Page numbers
        for (
          let i = Math.max(1, pagination.currentPage - 2);
          i <= Math.min(pagination.totalPages, pagination.currentPage + 2);
          i++
        ) {
          paginationHTML += `<a href="#" class="page-btn ${
            i === pagination.currentPage ? "active" : ""
          }" onclick="loadUsers(${i})">${i}</a>`;
        }

        // Next page
        if (pagination.currentPage < pagination.totalPages) {
          paginationHTML += `<a href="#" class="page-btn" onclick="loadUsers(${
            pagination.currentPage + 1
          })">Next</a>`;
        }

        paginationHTML += "</div>";
        container.innerHTML = paginationHTML;
      }

      function viewUserDetails(userId) {
        API.post("get_user_details.php", { user_id: userId })
          .then((response) => {
            if (response.success) {
              const user = response.data.user;
              const detailsHTML = `
                <div class="row">
                  <div class="col-md-6">
                    <h6>Basic Information</h6>
                    <table class="table table-sm">
                      <tr><td><strong>ID:</strong></td><td>${user.id}</td></tr>
                      <tr><td><strong>Username:</strong></td><td>${Utils.escapeHtml(
                        user.username
                      )}</td></tr>
                      <tr><td><strong>Email:</strong></td><td>${Utils.escapeHtml(
                        user.email
                      )}</td></tr>
                      <tr><td><strong>Full Name:</strong></td><td>${Utils.escapeHtml(
                        user.full_name || "N/A"
                      )}</td></tr>
                      <tr><td><strong>Role:</strong></td><td>${getRoleBadge(
                        user.role
                      )}</td></tr>
                    </table>
                  </div>
                  <div class="col-md-6">
                    <h6>Status Information</h6>
                    <table class="table table-sm">
                      <tr><td><strong>Status:</strong></td><td>${getStatusBadge(
                        user
                      )}</td></tr>
                      <tr><td><strong>Created:</strong></td><td>${new Date(
                        user.created_at
                      ).toLocaleString()}</td></tr>
                      <tr><td><strong>Last Login:</strong></td><td>${
                        user.last_login
                          ? new Date(user.last_login).toLocaleString()
                          : "Never"
                      }</td></tr>
                      <tr><td><strong>Login Count:</strong></td><td>${
                        user.login_count || 0
                      }</td></tr>
                    </table>
                  </div>
                </div>
              `;
              document.getElementById("userDetailsContent").innerHTML =
                detailsHTML;
              $("#userDetailsModal").modal("show");
            } else {
              Notifications.error("Error", response.message);
            }
          })
          .catch((error) => {
            console.error("Error loading user details:", error);
            Notifications.error("Error", "Failed to load user details");
          });
      }

      function editUser(userId) {
        API.post("get_user_details.php", { user_id: userId })
          .then((response) => {
            if (response.success) {
              const user = response.data.user;
              document.getElementById("editUserId").value = user.id;
              document.getElementById("editUsername").value = user.username;
              document.getElementById("editEmail").value = user.email;
              document.getElementById("editFullName").value =
                user.full_name || "";
              document.getElementById("editRole").value = user.role;
              document.getElementById("editIsActive").checked = user.is_active;
              $("#userEditModal").modal("show");
            } else {
              Notifications.error("Error", response.message);
            }
          })
          .catch((error) => {
            console.error("Error loading user for edit:", error);
            Notifications.error("Error", "Failed to load user data");
          });
      }

      function saveUserChanges() {
        const userId = document.getElementById("editUserId").value;
        const userData = {
          user_id: userId,
          email: document.getElementById("editEmail").value,
          full_name: document.getElementById("editFullName").value,
          role: document.getElementById("editRole").value,
          is_active: document.getElementById("editIsActive").checked,
        };

        API.post("update_user.php", userData)
          .then((response) => {
            if (response.success) {
              Notifications.success("Success", "User updated successfully");
              $("#userEditModal").modal("hide");
              loadUsers(currentUsersPage);
              loadUserStats();
            } else {
              Notifications.error("Error", response.message);
            }
          })
          .catch((error) => {
            console.error("Error updating user:", error);
            Notifications.error("Error", "Failed to update user");
          });
      }

      function activateUser(userId) {
        Notifications.confirm(
          "Activate User",
          "Are you sure you want to activate this user?"
        ).then((result) => {
          if (result.isConfirmed) {
            API.post("update_user_status.php", {
              user_id: userId,
              action: "activate",
            }).then((response) => {
              if (response.success) {
                Notifications.success("Success", "User activated successfully");
                loadUsers(currentUsersPage);
                loadUserStats();
              } else {
                Notifications.error("Error", response.message);
              }
            });
          }
        });
      }

      function deactivateUser(userId) {
        Notifications.confirm(
          "Deactivate User",
          "Are you sure you want to deactivate this user?"
        ).then((result) => {
          if (result.isConfirmed) {
            API.post("update_user_status.php", {
              user_id: userId,
              action: "deactivate",
            }).then((response) => {
              if (response.success) {
                Notifications.success(
                  "Success",
                  "User deactivated successfully"
                );
                loadUsers(currentUsersPage);
                loadUserStats();
              } else {
                Notifications.error("Error", response.message);
              }
            });
          }
        });
      }

      function showReportsModal() {
        Notifications.info(
          "Reports & Analytics",
          "Advanced reporting feature coming soon!"
        );
      }

      function showSystemSettings() {
        Notifications.info(
          "System Settings",
          "System settings feature coming soon!"
        );
      }

      function logout() {
        Notifications.confirm(
          "Logout",
          "Are you sure you want to logout?"
        ).then((result) => {
          if (result.isConfirmed) {
            Session.logout()
              .then(() => {
                window.location.href = "../index.html";
              })
              .catch(() => {
                window.location.href = "../index.html";
              });
          }
        });
      }
    </script>
  </body>
</html>
