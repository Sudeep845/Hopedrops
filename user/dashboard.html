<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Dashboard - HopeDrops</title>
    <meta
      name="description"
      content="HopeDrops User Dashboard - Blood Donation Tracking and Rewards"
    />

    <!-- Favicon -->
    <link
      rel="icon"
      type="image/x-icon"
      href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTE2IDMuMkMxMC4zIDMuMiA1LjcgNy44IDUuNyAxMy41QzUuNyAxOS4yIDEwLjMgMjMuOCAxNiAyMy44QzIxLjcgMjMuOCAyNi4zIDE5LjIgMjYuMyAxMy41QzI2LjMgNy44IDIxLjcgMy4yIDE2IDMuMloiIGZpbGw9IiNkYzM1NDUiLz4KPHBhdGggZD0iTTE2IDhWMTlIMTJWMTZIOVYxMkgxMlY4SDE2WiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+"
    />

    <!-- CSS -->
    <link rel="stylesheet" href="../css/style.css" />

    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <!-- SweetAlert2 for alerts -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
    />

    <!-- Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      .user-header {
        background: linear-gradient(
          135deg,
          var(--success-green),
          var(--primary-red)
        );
        color: var(--accent-white);
        padding: 1rem 0;
        box-shadow: var(--shadow-md);
      }

      .user-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .user-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: var(--accent-white);
        color: var(--primary-red);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2rem;
      }

      .donation-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .stat-card-user {
        background: var(--accent-white);
        padding: 1.5rem;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-md);
        text-align: center;
        position: relative;
        transition: transform var(--transition-fast);
      }

      .stat-card-user:hover {
        transform: translateY(-3px);
      }

      .stat-card-user.primary {
        border-left: 4px solid var(--primary-red);
      }

      .stat-card-user.success {
        border-left: 4px solid var(--success-green);
      }

      .stat-card-user.warning {
        border-left: 4px solid var(--warning-orange);
      }

      .stat-card-user.info {
        border-left: 4px solid var(--info-blue);
      }

      .stat-number-large {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
      }

      .stat-number-large.primary {
        color: var(--primary-red);
      }
      .stat-number-large.success {
        color: var(--success-green);
      }
      .stat-number-large.warning {
        color: var(--warning-orange);
      }
      .stat-number-large.info {
        color: var(--info-blue);
      }

      .next-donation-card {
        background: linear-gradient(
          135deg,
          var(--primary-red),
          var(--primary-red-dark)
        );
        color: var(--accent-white);
        padding: 2rem;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-lg);
        margin-bottom: 2rem;
        text-align: center;
      }

      .countdown-timer {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin: 1rem 0;
      }

      .countdown-item {
        background: rgba(255, 255, 255, 0.2);
        padding: 0.75rem;
        border-radius: var(--border-radius-md);
        min-width: 60px;
      }

      .countdown-number {
        font-size: 1.5rem;
        font-weight: bold;
        display: block;
      }

      .countdown-label {
        font-size: 0.8rem;
        opacity: 0.9;
      }

      .quick-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .action-card {
        background: var(--accent-white);
        padding: 1.5rem;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-md);
        cursor: pointer;
        transition: all var(--transition-fast);
        border: 2px solid transparent;
        text-decoration: none;
        color: inherit;
      }

      .action-card:hover {
        transform: translateY(-3px);
        border-color: var(--primary-red);
        text-decoration: none;
        color: inherit;
      }

      .action-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin: 0 auto 1rem;
      }

      .action-icon.search {
        background: #e3f2fd;
        color: #1976d2;
      }
      .action-icon.history {
        background: #f3e5f5;
        color: #7b1fa2;
      }
      .action-icon.rewards {
        background: #fff3e0;
        color: #f57c00;
      }
      .action-icon.schedule {
        background: #e8f5e8;
        color: #388e3c;
      }

      .blood-compatibility-card {
        background: var(--accent-white);
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-md);
        padding: 1.5rem;
        margin-bottom: 2rem;
      }

      .compatibility-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
      }

      .compatibility-item {
        padding: 1rem;
        border: 2px solid var(--accent-border);
        border-radius: var(--border-radius-md);
        text-align: center;
      }

      .compatibility-item.can-donate {
        border-color: var(--success-green);
        background: rgba(56, 142, 60, 0.1);
      }

      .compatibility-item.can-receive {
        border-color: var(--info-blue);
        background: rgba(25, 118, 210, 0.1);
      }

      .blood-types-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        justify-content: center;
        margin-top: 0.5rem;
      }

      .blood-type-tag {
        background: var(--primary-red);
        color: var(--accent-white);
        padding: 0.25rem 0.75rem;
        border-radius: var(--border-radius-lg);
        font-size: 0.8rem;
        font-weight: bold;
      }

      .rewards-summary {
        background: linear-gradient(135deg, var(--warning-orange), #ff8f00);
        color: var(--accent-white);
        padding: 1.5rem;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-lg);
        margin-bottom: 2rem;
      }

      .rewards-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .rewards-points {
        font-size: 2rem;
        font-weight: bold;
      }

      .upcoming-campaigns {
        background: var(--accent-white);
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-md);
      }

      .campaign-item {
        padding: 1rem;
        border-bottom: 1px solid var(--accent-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .campaign-item:last-child {
        border-bottom: none;
      }

      .campaign-info {
        flex: 1;
      }

      .campaign-title {
        font-weight: 600;
        margin-bottom: 0.25rem;
      }

      .campaign-meta {
        font-size: 0.8rem;
        color: var(--secondary-gray);
      }

      .recent-activity {
        background: var(--accent-white);
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-md);
      }

      .activity-item {
        padding: 1rem;
        border-bottom: 1px solid var(--accent-border);
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .activity-item:last-child {
        border-bottom: none;
      }

      .activity-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
      }

      .activity-icon.donation {
        background: #ffebee;
        color: #d32f2f;
      }
      .activity-icon.appointment {
        background: #e3f2fd;
        color: #1976d2;
      }
      .activity-icon.reward {
        background: #fff3e0;
        color: #f57c00;
      }

      .eligibility-status {
        padding: 1rem;
        border-radius: var(--border-radius-md);
        margin-bottom: 2rem;
        text-align: center;
      }

      .eligibility-status.eligible {
        background: var(--success-green);
        color: var(--accent-white);
      }

      .eligibility-status.ineligible {
        background: var(--danger-red);
        color: var(--accent-white);
      }

      .eligibility-status.pending {
        background: var(--warning-orange);
        color: var(--accent-white);
      }

      @media (max-width: 768px) {
        .donation-stats {
          grid-template-columns: repeat(2, 1fr);
        }

        .quick-actions {
          grid-template-columns: 1fr;
        }

        .rewards-content {
          flex-direction: column;
          gap: 1rem;
          text-align: center;
        }

        .compatibility-info {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- User Header -->
    <header class="user-header">
      <div class="container">
        <nav class="user-nav">
          <div class="navbar-brand">
            <div class="logo-icon">
              <i class="fas fa-tint"></i>
            </div>
            HopeDrops
          </div>

          <div class="user-info">
            <div class="user-avatar" id="userAvatar">U</div>
            <div>
              <div style="font-weight: 500" id="userName">User</div>
              <div style="font-size: 0.8rem; opacity: 0.9" id="userBloodType">
                Blood Donor
              </div>
            </div>
            <div class="dropdown">
              <button
                class="btn btn-light btn-sm dropdown-toggle"
                type="button"
              >
                <i class="fas fa-cog"></i>
              </button>
              <div class="dropdown-menu">
                <a class="dropdown-item" href="#" onclick="showProfileModal()"
                  ><i class="fas fa-user"></i> Profile</a
                >
                <a class="dropdown-item" href="#" onclick="logout()"
                  ><i class="fas fa-sign-out-alt"></i> Logout</a
                >
              </div>
            </div>
          </div>
        </nav>
      </div>
    </header>

    <div class="dashboard">
      <!-- Sidebar Navigation -->
      <aside class="sidebar">
        <nav class="sidebar-nav">
          <ul>
            <li class="sidebar-nav-item">
              <a href="dashboard.html" class="sidebar-nav-link active">
                <i class="fas fa-tachometer-alt"></i> Dashboard
              </a>
            </li>
            <li class="sidebar-nav-item">
              <a href="search_blood.html" class="sidebar-nav-link">
                <i class="fas fa-search"></i> Find Blood Banks
              </a>
            </li>
            <li class="sidebar-nav-item">
              <a href="history.html" class="sidebar-nav-link">
                <i class="fas fa-history"></i> Donation History
              </a>
            </li>
            <li class="sidebar-nav-item">
              <a href="rewards.html" class="sidebar-nav-link">
                <i class="fas fa-trophy"></i> Rewards & Badges
              </a>
            </li>
            <li class="sidebar-nav-item">
              <a
                href="#"
                onclick="showAppointmentModal()"
                class="sidebar-nav-link"
              >
                <i class="fas fa-calendar-check"></i> Appointments
              </a>
            </li>
            <li class="sidebar-nav-item">
              <a
                href="#"
                onclick="showCampaignsModal()"
                class="sidebar-nav-link"
              >
                <i class="fas fa-bullhorn"></i> Campaigns
              </a>
            </li>
          </ul>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Eligibility Status -->
        <div class="eligibility-status eligible" id="eligibilityStatus">
          <h4>
            <i class="fas fa-check-circle"></i> You are eligible to donate!
          </h4>
          <p id="eligibilityMessage">
            You can donate blood and help save lives.
          </p>
        </div>

        <!-- Next Donation Card -->
        <div class="next-donation-card" id="nextDonationCard">
          <h3><i class="fas fa-calendar-alt"></i> Next Donation Available</h3>
          <div class="countdown-timer" id="countdownTimer">
            <div class="countdown-item">
              <span class="countdown-number" id="days">0</span>
              <span class="countdown-label">Days</span>
            </div>
            <div class="countdown-item">
              <span class="countdown-number" id="hours">0</span>
              <span class="countdown-label">Hours</span>
            </div>
            <div class="countdown-item">
              <span class="countdown-number" id="minutes">0</span>
              <span class="countdown-label">Minutes</span>
            </div>
          </div>
          <p id="nextDonationText">You can donate blood now!</p>
          <button class="btn btn-light btn-lg" onclick="scheduleAppointment()">
            <i class="fas fa-calendar-plus"></i> Schedule Donation
          </button>
        </div>

        <!-- Donation Statistics -->
        <div class="donation-stats">
          <div class="stat-card-user primary">
            <div class="stat-number-large primary" id="totalDonations">0</div>
            <div class="stat-label">Total Donations</div>
          </div>

          <div class="stat-card-user success">
            <div class="stat-number-large success" id="lifeSaved">0</div>
            <div class="stat-label">Lives Potentially Saved</div>
          </div>

          <div class="stat-card-user warning">
            <div class="stat-number-large warning" id="rewardPoints">0</div>
            <div class="stat-label">Reward Points</div>
          </div>

          <div class="stat-card-user info">
            <div class="stat-number-large info" id="consecutiveDonations">
              0
            </div>
            <div class="stat-label">Consecutive Donations</div>
          </div>
        </div>

        <!-- Rewards Summary -->
        <div class="rewards-summary">
          <div class="rewards-content">
            <div>
              <h4><i class="fas fa-trophy"></i> Rewards Summary</h4>
              <div class="rewards-points">
                <span id="totalPoints">0</span> Points
              </div>
            </div>
            <div>
              <button
                class="btn btn-light"
                onclick="window.location.href='rewards.html'"
              >
                <i class="fas fa-gift"></i> View Rewards
              </button>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
          <a href="search_blood.html" class="action-card">
            <div class="action-icon search">
              <i class="fas fa-search"></i>
            </div>
            <h4>Find Blood Banks</h4>
            <p>
              Search for nearby hospitals and blood banks for donation or
              emergency needs
            </p>
          </a>

          <a href="history.html" class="action-card">
            <div class="action-icon history">
              <i class="fas fa-history"></i>
            </div>
            <h4>Donation History</h4>
            <p>
              View your complete donation history and track your contribution
            </p>
          </a>

          <a href="rewards.html" class="action-card">
            <div class="action-icon rewards">
              <i class="fas fa-trophy"></i>
            </div>
            <h4>Rewards & Badges</h4>
            <p>Check your earned badges, rewards, and redeem points</p>
          </a>

          <div class="action-card" onclick="scheduleAppointment()">
            <div class="action-icon schedule">
              <i class="fas fa-calendar-plus"></i>
            </div>
            <h4>Schedule Appointment</h4>
            <p>Book your next blood donation appointment at a nearby center</p>
          </div>
        </div>

        <!-- Blood Compatibility Information -->
        <div class="blood-compatibility-card">
          <h4><i class="fas fa-info-circle"></i> Your Blood Compatibility</h4>
          <div class="compatibility-info">
            <div class="compatibility-item can-donate">
              <h6><i class="fas fa-heart"></i> You Can Donate To</h6>
              <div class="blood-types-list" id="canDonateTo">
                <!-- Will be populated dynamically -->
              </div>
            </div>
            <div class="compatibility-item can-receive">
              <h6>
                <i class="fas fa-hand-holding-heart"></i> You Can Receive From
              </h6>
              <div class="blood-types-list" id="canReceiveFrom">
                <!-- Will be populated dynamically -->
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Activity and Upcoming Campaigns -->
        <div class="row">
          <div class="col-6">
            <div class="recent-activity">
              <div class="card-header">
                <h4><i class="fas fa-clock"></i> Recent Activity</h4>
              </div>
              <div
                class="card-body"
                style="max-height: 300px; overflow-y: auto"
              >
                <div id="recentActivity">
                  <!-- Activities will be loaded dynamically -->
                </div>
              </div>
            </div>
          </div>

          <div class="col-6">
            <div class="upcoming-campaigns">
              <div class="card-header">
                <h4><i class="fas fa-bullhorn"></i> Upcoming Campaigns</h4>
              </div>
              <div
                class="card-body"
                style="max-height: 300px; overflow-y: auto"
              >
                <div id="upcomingCampaigns">
                  <!-- Campaigns will be loaded dynamically -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Profile Modal -->
    <div class="modal fade" id="profileModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-user"></i> Profile Information
            </h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body" id="profileContent">
            <!-- Profile content will be loaded here -->
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="editProfile()"
            >
              <i class="fas fa-edit"></i> Edit Profile
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="../js/main.js"></script>

    <script>
      let userData = null;
      let countdownInterval = null;

      document.addEventListener("DOMContentLoaded", function () {
        // Check user authentication
        checkUserAuth();

        // Load dashboard data
        loadUserStats();
        loadRecentActivity();
        loadUpcomingCampaigns();

        // Start countdown timer
        startNextDonationCountdown();

        // Set up auto-refresh
        setInterval(() => {
          loadUserStats();
          loadRecentActivity();
        }, 60000); // Refresh every minute
      });

      function checkUserAuth(retryCount = 0) {
        // Ensure Session object is available
        if (typeof Session === "undefined") {
          console.error("Session object not found - main.js may not be loaded");
          setTimeout(() => checkUserAuth(retryCount), 100); // Retry after 100ms
          return;
        }

        Session.checkSession()
          .then((user) => {
            if (!user || user.role !== "donor") {
              // Retry up to 3 times in case of timing issues
              if (retryCount < 3) {
                console.log(
                  `Auth failed - user: ${user}, retrying (${
                    retryCount + 1
                  }/3)...`
                );
                setTimeout(() => checkUserAuth(retryCount + 1), 500);
                return;
              }

              console.log("Auth failed after retries - user:", user);
              Notifications.error("Access Denied", "Donor access required");
              window.location.href = "../login.html?role=donor";
              return;
            }

            userData = user;
            console.log("Authentication successful:", user.username);

            // Update user info
            document.getElementById("userName").textContent = user.full_name;
            document.getElementById("userAvatar").textContent = user.full_name
              .charAt(0)
              .toUpperCase();
            document.getElementById("userBloodType").textContent =
              user.blood_type ? `${user.blood_type} Donor` : "Blood Donor";

            // Load blood compatibility
            loadBloodCompatibility(user.blood_type);

            // Check eligibility
            checkEligibility();
          })
          .catch((error) => {
            // Retry up to 3 times in case of timing issues
            if (retryCount < 3) {
              console.log(
                `Session check failed, retrying (${retryCount + 1}/3):`,
                error.message
              );
              setTimeout(() => checkUserAuth(retryCount + 1), 500);
              return;
            }

            console.error("Auth check failed after retries:", error);
            console.log("Redirecting to login due to error:", error.message);
            window.location.href = "../login.html?role=donor";
          });
      }

      function loadUserStats() {
        API.get("get_user_stats.php")
          .then((response) => {
            if (response.success) {
              const stats = response.data;

              document.getElementById("totalDonations").textContent =
                stats.total_donations || 0;
              document.getElementById("lifeSaved").textContent =
                stats.total_donations * 3 || 0; // Assuming 3 lives per donation
              document.getElementById("rewardPoints").textContent =
                stats.reward_points || 0;
              document.getElementById("totalPoints").textContent =
                stats.reward_points || 0;
              document.getElementById("consecutiveDonations").textContent =
                stats.consecutive_donations || 0;
            }
          })
          .catch((error) => {
            console.error("Error loading user stats:", error);
          });
      }

      function checkEligibility() {
        API.get("check_donation_eligibility.php")
          .then((response) => {
            if (response.success) {
              const eligibility = response.data;
              const statusDiv = document.getElementById("eligibilityStatus");
              const messageEl = document.getElementById("eligibilityMessage");

              statusDiv.className = `eligibility-status ${eligibility.status}`;

              switch (eligibility.status) {
                case "eligible":
                  statusDiv.innerHTML =
                    '<h4><i class="fas fa-check-circle"></i> You are eligible to donate!</h4>';
                  messageEl.textContent =
                    "You can donate blood and help save lives.";
                  break;
                case "ineligible":
                  statusDiv.innerHTML =
                    '<h4><i class="fas fa-times-circle"></i> Currently Ineligible</h4>';
                  messageEl.textContent =
                    eligibility.reason ||
                    "Please wait before your next donation.";
                  break;
                case "pending":
                  statusDiv.innerHTML =
                    '<h4><i class="fas fa-clock"></i> Eligibility Pending</h4>';
                  messageEl.textContent = "Your eligibility is being reviewed.";
                  break;
              }
            }
          })
          .catch((error) => {
            console.error("Error checking eligibility:", error);
          });
      }

      function startNextDonationCountdown() {
        API.get("get_next_donation_date.php")
          .then((response) => {
            if (response.success) {
              const nextDate = new Date(response.data.next_donation_date);
              const now = new Date();

              if (nextDate <= now) {
                // Can donate now
                document.getElementById("nextDonationText").textContent =
                  "You can donate blood now!";
                document.getElementById("countdownTimer").style.display =
                  "none";
              } else {
                // Start countdown
                countdownInterval = setInterval(() => {
                  updateCountdown(nextDate);
                }, 1000);
              }
            }
          })
          .catch((error) => {
            console.error("Error loading next donation date:", error);
          });
      }

      function updateCountdown(targetDate) {
        const now = new Date().getTime();
        const distance = targetDate.getTime() - now;

        if (distance < 0) {
          // Countdown finished
          clearInterval(countdownInterval);
          document.getElementById("nextDonationText").textContent =
            "You can donate blood now!";
          document.getElementById("countdownTimer").style.display = "none";
          return;
        }

        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor(
          (distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)
        );
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));

        document.getElementById("days").textContent = days;
        document.getElementById("hours").textContent = hours;
        document.getElementById("minutes").textContent = minutes;
      }

      function loadBloodCompatibility(bloodType) {
        if (!bloodType) return;

        const compatibilityData = {
          "O-": {
            canDonateTo: ["O-", "O+", "A-", "A+", "B-", "B+", "AB-", "AB+"],
            canReceiveFrom: ["O-"],
          },
          "O+": {
            canDonateTo: ["O+", "A+", "B+", "AB+"],
            canReceiveFrom: ["O-", "O+"],
          },
          "A-": {
            canDonateTo: ["A-", "A+", "AB-", "AB+"],
            canReceiveFrom: ["O-", "A-"],
          },
          "A+": {
            canDonateTo: ["A+", "AB+"],
            canReceiveFrom: ["O-", "O+", "A-", "A+"],
          },
          "B-": {
            canDonateTo: ["B-", "B+", "AB-", "AB+"],
            canReceiveFrom: ["O-", "B-"],
          },
          "B+": {
            canDonateTo: ["B+", "AB+"],
            canReceiveFrom: ["O-", "O+", "B-", "B+"],
          },
          "AB-": {
            canDonateTo: ["AB-", "AB+"],
            canReceiveFrom: ["O-", "A-", "B-", "AB-"],
          },
          "AB+": {
            canDonateTo: ["AB+"],
            canReceiveFrom: ["O-", "O+", "A-", "A+", "B-", "B+", "AB-", "AB+"],
          },
        };

        const compatibility = compatibilityData[bloodType];
        if (compatibility) {
          document.getElementById("canDonateTo").innerHTML =
            compatibility.canDonateTo
              .map((type) => `<span class="blood-type-tag">${type}</span>`)
              .join("");

          document.getElementById("canReceiveFrom").innerHTML =
            compatibility.canReceiveFrom
              .map((type) => `<span class="blood-type-tag">${type}</span>`)
              .join("");
        }
      }

      function loadRecentActivity() {
        API.get("get_user_activities.php", { limit: 5 })
          .then((response) => {
            if (response.success) {
              displayRecentActivity(response.data);
            }
          })
          .catch((error) => {
            console.error("Error loading recent activity:", error);
          });
      }

      function displayRecentActivity(activities) {
        const container = document.getElementById("recentActivity");

        if (activities.length === 0) {
          container.innerHTML =
            '<p class="text-muted">No recent activities</p>';
          return;
        }

        container.innerHTML = activities
          .map(
            (activity) => `
                <div class="activity-item">
                    <div class="activity-icon ${getActivityClass(
                      activity.activity_type
                    )}">
                        <i class="fas fa-${getActivityIcon(
                          activity.activity_type
                        )}"></i>
                    </div>
                    <div class="activity-content">
                        <div>${formatActivityText(activity)}</div>
                        <small class="text-muted">${Utils.timeAgo(
                          activity.created_at
                        )}</small>
                    </div>
                </div>
            `
          )
          .join("");
      }

      function getActivityClass(type) {
        const classes = {
          donation: "donation",
          appointment: "appointment",
          reward_earned: "reward",
          registration: "appointment",
        };
        return classes[type] || "appointment";
      }

      function getActivityIcon(type) {
        const icons = {
          donation: "tint",
          appointment: "calendar-check",
          reward_earned: "trophy",
          registration: "user-plus",
        };
        return icons[type] || "circle";
      }

      function formatActivityText(activity) {
        switch (activity.activity_type) {
          case "donation":
            return `Blood donation completed at ${
              activity.location || "hospital"
            }`;
          case "appointment":
            return `Appointment scheduled for ${Utils.formatDate(
              activity.appointment_date
            )}`;
          case "reward_earned":
            return `Earned ${activity.points} reward points - ${activity.description}`;
          case "registration":
            return "Registered as a blood donor";
          default:
            return activity.description || "Activity recorded";
        }
      }

      function loadUpcomingCampaigns() {
        API.get("get_user_campaigns.php", { limit: 5 })
          .then((response) => {
            if (response.success) {
              displayUpcomingCampaigns(response.data);
            }
          })
          .catch((error) => {
            console.error("Error loading campaigns:", error);
          });
      }

      function displayUpcomingCampaigns(campaigns) {
        const container = document.getElementById("upcomingCampaigns");

        if (campaigns.length === 0) {
          container.innerHTML =
            '<p class="text-muted">No upcoming campaigns</p>';
          return;
        }

        container.innerHTML = campaigns
          .map(
            (campaign) => `
                <div class="campaign-item">
                    <div class="campaign-info">
                        <div class="campaign-title">${Utils.escapeHtml(
                          campaign.title
                        )}</div>
                        <div class="campaign-meta">
                            <i class="fas fa-map-marker-alt"></i> ${Utils.escapeHtml(
                              campaign.location
                            )} â€¢ 
                            <i class="fas fa-calendar"></i> ${Utils.formatDate(
                              campaign.start_date
                            )}
                        </div>
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="registerForCampaign(${
                      campaign.id
                    })">
                        <i class="fas fa-plus"></i> Join
                    </button>
                </div>
            `
          )
          .join("");
      }

      function registerForCampaign(campaignId) {
        Notifications.confirm(
          "Join Campaign",
          "Would you like to register for this blood donation campaign?",
          "Yes, Join Campaign",
          "success"
        ).then((result) => {
          if (result.isConfirmed) {
            API.post("register_campaign.php", { campaign_id: campaignId })
              .then((response) => {
                if (response.success) {
                  Notifications.success(
                    "Success",
                    "You have been registered for the campaign!"
                  );
                  loadUpcomingCampaigns(); // Refresh the list
                } else {
                  throw new Error(response.message);
                }
              })
              .catch((error) => {
                console.error("Error registering for campaign:", error);
                Notifications.error(
                  "Error",
                  "Failed to register: " + error.message
                );
              });
          }
        });
      }

      function scheduleAppointment() {
        Notifications.info(
          "Schedule Appointment",
          "Appointment scheduling feature coming soon! Please visit your nearest blood bank or hospital."
        );
      }

      function showProfileModal() {
        if (!userData) return;

        const content = document.getElementById("profileContent");
        content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-user"></i> Personal Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Full Name:</strong></td><td>${Utils.escapeHtml(
                              userData.full_name
                            )}</td></tr>
                            <tr><td><strong>Email:</strong></td><td>${Utils.escapeHtml(
                              userData.email
                            )}</td></tr>
                            <tr><td><strong>Phone:</strong></td><td>${Utils.escapeHtml(
                              userData.phone
                            )}</td></tr>
                            <tr><td><strong>Blood Type:</strong></td><td><span class="blood-type-badge">${
                              userData.blood_type
                            }</span></td></tr>
                            <tr><td><strong>Date of Birth:</strong></td><td>${Utils.formatDate(
                              userData.date_of_birth
                            )}</td></tr>
                            <tr><td><strong>Gender:</strong></td><td>${Utils.escapeHtml(
                              userData.gender
                            )}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-map-marker-alt"></i> Address Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Address:</strong></td><td>${Utils.escapeHtml(
                              userData.address || "Not provided"
                            )}</td></tr>
                            <tr><td><strong>City:</strong></td><td>${Utils.escapeHtml(
                              userData.city || "Not provided"
                            )}</td></tr>
                            <tr><td><strong>State:</strong></td><td>${Utils.escapeHtml(
                              userData.state || "Not provided"
                            )}</td></tr>
                            <tr><td><strong>Postal Code:</strong></td><td>${Utils.escapeHtml(
                              userData.postal_code || "Not provided"
                            )}</td></tr>
                        </table>
                        
                        <h6 class="mt-3"><i class="fas fa-info-circle"></i> Account Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Member Since:</strong></td><td>${Utils.formatDate(
                              userData.created_at
                            )}</td></tr>
                            <tr><td><strong>Last Updated:</strong></td><td>${Utils.formatDate(
                              userData.updated_at
                            )}</td></tr>
                            <tr><td><strong>Account Status:</strong></td><td><span class="badge badge-success">Active</span></td></tr>
                        </table>
                    </div>
                </div>
            `;

        $("#profileModal").modal("show");
      }

      function editProfile() {
        Notifications.info(
          "Edit Profile",
          "Profile editing feature coming soon!"
        );
      }

      // Modal functions for other features
      function showAppointmentModal() {
        Notifications.info(
          "Appointments",
          "Appointment management feature coming soon!"
        );
      }

      function showCampaignsModal() {
        Notifications.info(
          "Campaigns",
          "Campaign management feature coming soon!"
        );
      }

      function logout() {
        Notifications.confirm(
          "Logout",
          "Are you sure you want to logout?"
        ).then((result) => {
          if (result.isConfirmed) {
            Session.logout()
              .then(() => {
                window.location.href = "../index.html";
              })
              .catch(() => {
                window.location.href = "../index.html";
              });
          }
        });
      }
    </script>
  </body>
</html>
